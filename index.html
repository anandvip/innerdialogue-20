<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inner Dialogue with All Features</title>
  <style>
    /* Your provided CSS styles */
    /* Base Styles */
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 1rem;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      color: #2c3e50;
      transition: background-color 0.3s, color 0.3s;
    }

    body.dark-mode {
      background: linear-gradient(135deg, #2c3e50, #1a1a1a);
      color: #f5f7fa;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: inherit;
    }

    /* Theme Switcher */
    .theme-switcher {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
      padding: 0.5rem;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .theme-switcher:hover {
      background: rgba(255, 255, 255, 1);
    }

    .dark-mode .theme-switcher {
      background: rgba(33, 37, 41, 0.9);
      color: white;
    }

    .dark-mode .theme-switcher:hover {
      background: rgba(33, 37, 41, 1);
    }

    /* Hierarchy Styles */
    .group {
      margin-left: 1rem;
      border-left: 2px solid rgba(74, 85, 104, 0.1);
      padding-left: 1rem;
    }

    .group-header {
      display: flex;
      align-items: center;
      cursor: pointer;
      padding: 0.75rem;
      margin: 0.25rem 0;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .dark-mode .group-header {
      background: rgba(33, 37, 41, 0.8);
      color: white;
    }

    .group-header:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .group-header::before {
      content: "▶";
      margin-right: 0.75rem;
      font-size: 0.9rem;
      color: inherit;
      transition: transform 0.2s ease;
    }

    .group-header.expanded::before {
      content: "▼";
    }

    .group-content {
      display: none;
      margin-left: 1rem;
      padding-top: 0.5rem;
    }

    .group-content.expanded {
      display: block;
    }

    /* Entry Styles */
    .entry {
      position: relative;
      padding: 0.75rem;
      margin: 0.5rem 0;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      font-size: 0.9rem;
      transition: all 0.3s ease;
      cursor: pointer;
      overflow: hidden;
    }

    .dark-mode .entry {
      background: rgba(33, 37, 41, 0.9);
      color: white;
    }

    .entry:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Rich Text Editor */
    .rich-text-editor {
      padding: 0.5rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 0.9rem;
      line-height: 1.5;
      min-height: 100px;
      background: white;
      color: #2c3e50;
    }

    .dark-mode .rich-text-editor {
      background: #2c3e50;
      color: white;
    }

    .formatting-buttons {
      margin-bottom: 0.5rem;
    }

    .formatting-buttons button {
      padding: 0.25rem 0.5rem;
      margin-right: 0.25rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #e9ecef;
      transition: background-color 0.3s;
    }

    .formatting-buttons button:hover {
      background: #dee2e6;
    }

    .dark-mode .formatting-buttons button {
      background: #495057;
      color: white;
    }

    .dark-mode .formatting-buttons button:hover {
      background: #6c757d;
    }

    /* Delete Icon */
    .delete-icon {
      position: absolute;
      top: 50%;
      right: 0.75rem;
      transform: translateY(-50%);
      opacity: 0;
      cursor: pointer;
      color: #e53e3e;
      transition: opacity 0.3s ease;
    }

    .entry:hover .delete-icon {
      opacity: 1;
    }

    /* Undo Button */
    .undo-button {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      padding: 0.5rem 1rem;
      background: #228be6;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from { transform: translate(-50%, 100%); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }

    /* Toast Styles */
    .toast-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toast {
      padding: 0.75rem 1.25rem;
      background: rgba(33, 37, 41, 0.95);
      color: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      animation: slideIn 0.3s ease-out;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }

    .toast:hover {
      opacity: 0.9;
    }

    .toast.success {
      background: rgba(40, 167, 69, 0.95);
    }

    .toast.error {
      background: rgba(220, 53, 69, 0.95);
    }

    .toast.info {
      background: rgba(23, 162, 184, 0.95);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease;
    }
  </style>
</head>
<body>
  <h1>Inner Dialogue with All Features</h1>
  <div class="theme-switcher" onclick="toggleTheme()">🌓</div>
  <div id="journal-hierarchy"></div>

  <!-- Undo Button -->
  <button class="undo-button hidden" id="undo-button" onclick="undoDelete()">Undo</button>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <script type="module">
    // Import Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDocs, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB00L-6PsCK5LMAVbUPXgNNF0BywlZKqwk",
      authDomain: "weekly-journal-9df9c.firebaseapp.com",
      projectId: "weekly-journal-9df9c",
      storageBucket: "weekly-journal-9df9c.appspot.com",
      messagingSenderId: "267644429656",
      appId: "1:267644429656:web:8a5b8a73960f9adf5af12d"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // AI Provider Configuration
    const API_KEYS = {
      openai: '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',
      mistral: 'ic8ExdQksCSXrL4qo0sm9bdkwtKmDUCm',
      gemini: 'AIzaSyBPO0PQ4PltzLQOSGJOxbqnyt-8xAG7ZpA'
    };

    // Theme Switcher
    function toggleTheme() {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      document.body.classList.add('dark-mode');
    }

    // Toast System
    function showToast(message, type = "info") {
      const toastContainer = document.getElementById("toast-container");
      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.textContent = message;
      toastContainer.appendChild(toast);

      // Auto-dismiss after 3 seconds
      setTimeout(() => {
        toast.remove();
      }, 3000);

      // Manual dismiss on click
      toast.addEventListener("click", () => {
        toast.remove();
      });
    }

    // Undo Functionality
    let deletedEntry = null;
    let undoTimeout = null;

    function deleteEntry(entryElement, entry) {
      deletedEntry = { element: entryElement, data: entry };
      entryElement.style.opacity = '0';
      entryElement.style.transform = 'translateX(100%)';
      setTimeout(() => {
        entryElement.remove();
      }, 300);

      // Show undo button
      const undoButton = document.getElementById('undo-button');
      undoButton.classList.remove('hidden');

      // Hide undo button after 5 seconds
      undoTimeout = setTimeout(() => {
        undoButton.classList.add('hidden');
        deletedEntry = null;
      }, 5000);

      showToast('Entry deleted.', 'info');
    }

    function undoDelete() {
      if (deletedEntry) {
        const { element, data } = deletedEntry;
        const content = element.parentElement;
        content.insertBefore(element, content.firstChild);
        element.style.opacity = '1';
        element.style.transform = 'translateX(0)';
        deletedEntry = null;

        // Hide undo button
        const undoButton = document.getElementById('undo-button');
        undoButton.classList.add('hidden');
        clearTimeout(undoTimeout);

        showToast('Entry restored.', 'success');
      }
    }

    // Rich Text Support
    function setupRichTextEditor(editor) {
      const buttons = editor.previousElementSibling;
      buttons.querySelector('.bold').onclick = () => document.execCommand('bold');
      buttons.querySelector('.italic').onclick = () => document.execCommand('italic');
      buttons.querySelector('.underline').onclick = () => document.execCommand('underline');
    }

    // AI Integration
    class AIPromptGenerator {
      static async generate(keywords, provider) {
        const prompt = `Write a thoughtful, first-person journal entry about ${keywords}. Focus on self-growth, inner reflection, and emotional awareness.`;
        const endpoint = provider === 'gemini' 
          ? `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${API_KEYS[provider]}`
          : provider === 'openai'
          ? 'https://api.openai.com/v1/chat/completions'
          : 'https://api.mistral.ai/v1/chat/completions';

        const headers = {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${API_KEYS[provider]}`,
        };

        const requestBody = {
          model: provider === 'openai' ? 'gpt-3.5-turbo' : 'mistral-tiny',
          messages: [{ role: 'user', content: prompt }],
          max_tokens: 150,
          temperature: 0.7,
        };

        try {
          const response = await fetch(endpoint, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(requestBody),
          });

          if (!response.ok) {
            throw new Error('Failed to generate AI prompt.');
          }

          const data = await response.json();
          return data.choices[0].message.content;
        } catch (error) {
          console.error('Error generating AI prompt:', error);
          throw new Error('Failed to generate prompt.');
        }
      }
    }

    // Render the Hierarchy
    const journalHierarchy = document.getElementById('journal-hierarchy');

    function renderGroup(group, level) {
      const groupElement = document.createElement('div');
      groupElement.className = 'group fade-in';

      const header = document.createElement('div');
      header.className = 'group-header';
      header.textContent = level === 'year' ? `Year ${group.year}` :
                          level === 'month' ? `${new Date(group.year, group.month - 1).toLocaleString('default', { month: 'long' })}` :
                          level === 'week' ? `Week ${group.week}` : '';
      groupElement.appendChild(header);

      const content = document.createElement('div');
      content.className = 'group-content';
      groupElement.appendChild(content);

      if (level === 'year') {
        group.months.forEach(month => {
          content.appendChild(renderGroup(month, 'month'));
        });
      } else if (level === 'month') {
        group.weeks.forEach(week => {
          content.appendChild(renderGroup(week, 'week'));
        });
      } else if (level === 'week') {
        // Add AI Prompt Section for each week
        const aiPromptSection = document.createElement('div');
        aiPromptSection.className = 'ai-prompt-section';
        aiPromptSection.innerHTML = `
          <input type="text" placeholder="Enter keywords (e.g., growth, fear, gratitude)" class="ai-keywords" />
          <button onclick="generateAIPrompt(this, '${group.year}', '${group.month}', '${group.week}')">✨ Generate Journal Entry</button>
        `;
        content.appendChild(aiPromptSection);

        // Add "New Entry" button for each week
        const newEntryButton = document.createElement('button');
        newEntryButton.className = 'new-entry-button';
        newEntryButton.textContent = '➕ New Entry';
        newEntryButton.onclick = () => createNewEntry(content, group);
        content.appendChild(newEntryButton);

        // Render existing entries
        group.entries.forEach(entry => {
          const entryElement = createEntryElement(entry);
          content.appendChild(entryElement);
        });
      }

      // Toggle Expand/Collapse
      header.addEventListener('click', () => {
        header.classList.toggle('expanded');
        content.classList.toggle('expanded');
      });

      return groupElement;
    }

    // Generate AI-Powered Journal Entry
    async function generateAIPrompt(button, year, month, week) {
      const keywords = button.previousElementSibling.value.trim();
      if (!keywords) {
        showToast('Please enter some keywords.', 'error');
        return;
      }

      button.disabled = true;
      button.textContent = 'Generating...';

      try {
        const provider = 'openai'; // Default provider
        const generatedText = await AIPromptGenerator.generate(keywords, provider);

        // Add the generated entry to the selected week
        const newEntry = {
          id: `ai-${Date.now()}`,
          text: generatedText,
        };

        const weekGroup = entries
          .find(y => y.year == year)
          .months.find(m => m.month == month)
          .weeks.find(w => w.week == week);

        weekGroup.entries.push(newEntry);

        const entryElement = createEntryElement(newEntry);
        const content = button.closest('.group-content');
        content.insertBefore(entryElement, content.firstChild);

        showToast('Journal entry generated successfully!', 'success');
      } catch (error) {
        console.error('Error generating AI prompt:', error);
        showToast('Failed to generate journal entry. Please try again.', 'error');
      } finally {
        button.disabled = false;
        button.textContent = '✨ Generate Journal Entry';
      }
    }

    // Create New Entry
    function createNewEntry(content, group) {
      const newEntry = {
        id: `new-${Date.now()}`,
        text: '',
      };

      const entryElement = createEntryElement(newEntry);
      content.insertBefore(entryElement, content.firstChild);

      // Focus on the new entry's rich text editor
      const editor = entryElement.querySelector('.rich-text-editor');
      editor.focus();
    }

    // Create Entry Element
    function createEntryElement(entry) {
      const entryElement = document.createElement('div');
      entryElement.className = 'entry fade-in';

      // Rich Text Editor
      const formattingButtons = document.createElement('div');
      formattingButtons.className = 'formatting-buttons';
      formattingButtons.innerHTML = `
        <button class="bold">B</button>
        <button class="italic">I</button>
        <button class="underline">U</button>
      `;
      entryElement.appendChild(formattingButtons);

      const editor = document.createElement('div');
      editor.className = 'rich-text-editor';
      editor.contentEditable = true;
      editor.textContent = entry.text;
      entryElement.appendChild(editor);

      setupRichTextEditor(editor);

      // Delete Icon
      const deleteIcon = document.createElement('span');
      deleteIcon.className = 'delete-icon';
      deleteIcon.textContent = '🗑️';
      deleteIcon.onclick = () => deleteEntry(entryElement, entry);
      entryElement.appendChild(deleteIcon);

      return entryElement;
    }

    // Render the Entire Hierarchy
    entries.forEach(year => {
      journalHierarchy.appendChild(renderGroup(year, 'year'));
    });
  </script>
</body>
</html>